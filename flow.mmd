flowchart TD
    %% ì´ˆê¸° ì„¤ì • ë‹¨ê³„
    Start(["ì‹œë®¬ë ˆì´í„° ì‹œì‘"]) --> LoadConfig["ì„¤ì •ê°’ ë¡œë“œ<br/>ê¸°ê°„ / ì›ê¸ˆ / ì´ìœ¨ / ê±°ì¹˜ê¸°ê°„"]
    LoadConfig --> InitVars["ë³€ìˆ˜ ì´ˆê¸°í™”<br/>ê³„íšì”ì•¡ = ì›ê¸ˆ<br/>ì‹¤ì œì”ì•¡ = ì›ê¸ˆ<br/>ì´ì›”ì´ì = 0"]
    InitVars --> LoopStart{"ì›”ë³„ ë£¨í”„ ì‹œì‘<br/>(0 ~ ì´ ê°œì›”ìˆ˜)"}

    %% ë£¨í”„ ë‚´ë¶€ ë¡œì§
    subgraph Calculation_Loop [ì›”ë³„ ê³„ì‚° ë¡œì§]
        direction TB
        LoopStart --> PlanLogic["ğŸ“˜ ê³„íš(Plan) ê³„ì‚° ë‹¨ê³„"]

        %% 1. ê³„íš ì›ê¸ˆ ê³„ì‚° (Waterfall)
        PlanLogic --> CheckManual{"í•´ë‹¹ ì›”<br/>ìˆ˜ê¸° ì…ë ¥ê°’ ì¡´ì¬?"}

        CheckManual -- "Yes (ê³ ì •)" --> UseManual["ì²­êµ¬ì›ê¸ˆ = <br/>ìˆ˜ê¸° ì…ë ¥ê°’ ì‚¬ìš©"]
        CheckManual -- "No (ìë™)" --> CheckGrace{"ê±°ì¹˜ ê¸°ê°„ì¸ê°€?"}

        CheckGrace -- Yes --> ZeroPrincipal["ì²­êµ¬ì›ê¸ˆ = 0ì›"]
        CheckGrace -- No --> AutoDistribute["ìë™ ë¶„í•  ê³„ì‚°<br/>= ë‚¨ì€ ê³„íšì”ì•¡ / ë‚¨ì€ íšŸìˆ˜"]

        UseManual --> DeductPlan["ê³„íš ì”ì•¡ ê°±ì‹ <br/>ê³„íšì”ì•¡ -= ì²­êµ¬ì›ê¸ˆ"]
        ZeroPrincipal --> DeductPlan
        AutoDistribute --> DeductPlan

        %% 2. ì‹¤ì œ ë‚©ë¶€ ë° ì´ì ê³„ì‚°
        DeductPlan --> ActualLogic["ğŸ“• ì‹¤ì œ(Actual) ê³„ì‚° ë‹¨ê³„"]

        ActualLogic --> CalcInterest["ì´ì ê³„ì‚°<br/>= ì‹¤ì œ ì”ì•¡ * ì´ìœ¨ * ì¼ìˆ˜"]
        CalcInterest --> TotalBill["ì´ ì²­êµ¬ì•¡ í™•ì •<br/>= ì²­êµ¬ì›ê¸ˆ + ë‹¹ì›”ì´ì + ì´ì›”ì´ì"]

        TotalBill --> GetInput["ì‚¬ìš©ì ì‹¤ë‚©ë¶€ ì…ë ¥ê°’ í™•ì¸"]
        GetInput --> CalcArrears["ë¯¸ë‚© ì´ì(ì´ì›”) ê³„ì‚°"]
        GetInput --> DeductActual["ì‹¤ì œ ì”ì•¡ ê°±ì‹ <br/>ì‹¤ì œì”ì•¡ -= ì‹¤ë‚©ë¶€ì›ê¸ˆ"]

        CalcArrears --> NextIter["ë‹¤ìŒ ë‹¬ ì´ì›”ì´ì ê°±ì‹ "]
        DeductActual --> NextIter
    end

    NextIter --> CheckEnd{"ë§ˆì§€ë§‰ íšŒì°¨ì¸ê°€?"}
    CheckEnd -- No --> LoopStart
    CheckEnd -- Yes --> RenderUI["í…Œì´ë¸” í™”ë©´ ì¶œë ¥"]

    %% ê²°ê³¼ ì²˜ë¦¬
    RenderUI --> CheckBalance{"ìµœì¢… ì‹¤ì œì”ì•¡ > 0 ?"}
    CheckBalance -- Yes --> ShowWarning["âš ï¸ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ<br/>'ë¯¸ìƒí™˜ ì›ê¸ˆ ì¡´ì¬'"]
    CheckBalance -- No --> Finish(["ì™„ë£Œ"])

    %% ì‚¬ìš©ì ìƒí˜¸ì‘ìš© (ì´ë²¤íŠ¸)
    subgraph User_Actions [ì‚¬ìš©ì ë™ì‘]
        Event1["âœï¸ ì²­êµ¬ ì›ê¸ˆ ìˆ˜ì •"] -.-> UpdateManual["ìˆ˜ê¸° ë°ì´í„° ì €ì¥"]
        Event2["ğŸ’° ì‹¤ ë‚©ë¶€ì•¡ ì…ë ¥"] -.-> UpdatePayment["ë‚©ë¶€ ë°ì´í„° ì €ì¥"]

        UpdateManual --> ReCalc["ì „ì²´ ì¬ê³„ì‚° Trigger"]
        UpdatePayment --> ReCalc
        ReCalc ==> InitVars
    end

    %% ìŠ¤íƒ€ì¼ë§
    style Start fill:#333,stroke:#333,color:#fff
    style Finish fill:#333,stroke:#333,color:#fff
    style UseManual fill:#e0f2fe,stroke:#3b82f6,stroke-width:2px
    style AutoDistribute fill:#f0fdf4,stroke:#22c55e
    style ShowWarning fill:#fff7ed,stroke:#ea580c,color:#c2410c
    style ReCalc fill:#fef08a,stroke:#eab308,stroke-width:2px,stroke-dasharray: 5 5