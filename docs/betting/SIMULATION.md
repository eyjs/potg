# λ² ν… μ‹μ¤ν… κ²°ν•¨ μ‹λ®¬λ μ΄μ… (v2 - λ°°μ¨ κΈ°λ°)

## μ‹λ®¬λ μ΄μ… μ‹λ‚λ¦¬μ¤

### β… μ •μƒ μΌ€μ΄μ¤
```
λ² ν… λ¬Έν•­: "μ©ν›μ΄ 20λ°μ¤ μ΄μƒ?" (μ •λ‹µ: O, λ°°μ¨: 2.0)

νμ›A: O, 1000pt β†’ +2000pt (μΉλ¦¬)
νμ›B: O, 500pt  β†’ +1000pt (μΉλ¦¬)
νμ›C: X, 300pt  β†’ -300pt (ν¨λ°°)
νμ›D: X, 700pt  β†’ -700pt (ν¨λ°°)

μ •μ‚°:
- νμ›A: Math.ceil(1000 Γ— 2.0) = 2000pt
- νμ›B: Math.ceil(500 Γ— 2.0) = 1000pt
- νμ›C: -300pt
- νμ›D: -700pt
```

---

## β… ν•΄κ²°λ κ²°ν•¨λ“¤

### 1. ~~λ¨λ‘ ν‹€λ¦° κ²½μ° ν¬μΈνΈ μ¦λ°~~ β†’ β… ν•΄κ²°
```
λ² ν… λ¬Έν•­: "Bν€ μΉλ¦¬?" (μ •λ‹µ: X, λ°°μ¨: 2.0)

νμ›A: O, 1000pt β†’ -1000pt
νμ›B: O, 500pt  β†’ -500pt
νμ›C: O, 300pt  β†’ -300pt

κ²°κ³Ό: λ¨λ‘ ν¬μΈνΈ μ°¨κ°, μ‹μ¤ν…μ΄ ν¬μΈνΈ νμ
```

**ν•΄κ²°:** λ°°μ¨ κΈ°λ° μ‹μ¤ν…μ΄λ―€λ΅ λ§μ¶ μ‚¬λμ΄ μ—†μ–΄λ„ ν‹€λ¦° μ‚¬λλ§ ν¬μΈνΈ μ°¨κ°λ¨

---

### 2. ~~μ†μμ  λ¶„λ°° μ‹ ν¬μΈνΈ μ¦λ°/μƒμ„±~~ β†’ β… ν•΄κ²°
```
λ² ν… λ¬Έν•­: "20λ¶„ μ΄μƒ ν”λ μ΄?" (μ •λ‹µ: O, λ°°μ¨: 1.5)

νμ›A: O, 333pt β†’ Math.ceil(333 Γ— 1.5) = Math.ceil(499.5) = 500pt
νμ›B: O, 777pt β†’ Math.ceil(777 Γ— 1.5) = Math.ceil(1165.5) = 1166pt
νμ›C: X, 1000pt β†’ -1000pt
```

**ν•΄κ²°:** Math.ceil μ‚¬μ©μΌλ΅ μ†μμ  μ¬λ¦Ό μ²λ¦¬, ν¬μΈνΈ μ¦λ° μ—†μ

---

### 3. ~~Scrim.clanId Nullable μ²λ¦¬ μ• λ¨~~ β†’ β… ν•΄κ²°
```
Scrim.clanIdλ” μ΄μ  NOT NULL (ν•„μ)
κ°μΈ μ£Όμµ λ‚΄μ „μ€ μ—†μ, λ¨λ“  λ‚΄μ „μ€ ν΄λμ— μΆ…μ†
```

**ν•΄κ²°:** ERD μμ •μΌλ΅ κ°μΈ λ‚΄μ „ λ¶κ°€λ¥, clanId ν•­μƒ μ΅΄μ¬

---

### 4. ~~ν¬μΈνΈ μ°¨κ° μ‹μ κ³Ό μμ μ²λ¦¬ μ •μ±… λ¶λ…ν™•~~ β†’ β… ν•΄κ²°
```
λ² ν… μ μ¶ μ‹:
ClanMember.lockedPoints += betAmount (μ¦‰μ‹ μ κΈ)
ClanMember.totalPointsλ” μ μ§€

μ •μ‚° μ‹:
λ§μ¶ κ²½μ°: totalPoints += λ³΄μƒ, lockedPoints -= betAmount
ν‹€λ¦° κ²½μ°: totalPoints -= betAmount, lockedPoints -= betAmount
```

**ν•΄κ²°:** λ‘ μ»¬λΌ λ¶„λ¦¬λ΅ μ°¨κ° μ‹μ  λ…ν™•ν™”, μμ λ°©μ§€

---

## β μ—¬μ „ν μ΅΄μ¬ν•λ” μ—£μ§€ μΌ€μ΄μ¤

### 1. λ¨λ‘ λ§μ¶ κ²½μ° (μ‹μ¤ν… ν¬μΈνΈ μ¦κ°€)
```
λ² ν… λ¬Έν•­: "Aν€ μΉλ¦¬?" (μ •λ‹µ: O, λ°°μ¨: 2.0)

νμ›A: O, 1000pt β†’ +2000pt
νμ›B: O, 500pt  β†’ +1000pt
νμ›C: O, 300pt  β†’ +600pt

μ‹μ¤ν… ν¬μΈνΈ λ³€λ™:
μ§€κΈ‰: 2000 + 1000 + 600 = 3600pt
μ§•μ: 0pt
μμ¦κ°€: +3600pt
```

**κ²°κ³Ό:**
- β οΈ **μ‹μ¤ν…μ΄ ν¬μΈνΈλ¥Ό μƒμ„±ν•¨ (μΈν”λ μ΄μ…)**
- λ§μ¶”κΈ° μ‰¬μ΄ λ¬Έν•­μ— λ¨λ‘κ°€ λ² ν…ν•λ©΄ ν¬μΈνΈ ν­λ°μ  μ¦κ°€

**ν•΄κ²°μ±…:**
- μµμ… 1: ν‹€λ¦° μ‚¬λμ΄ μ—†μΌλ©΄ λ°°μ¨ 1.0 μ μ© (λ³Έμ „ λ°ν™)
- μµμ… 2: μµμ† μ–‘μΈ΅ λ² ν… λΉ„μ¨ μ”κµ¬ (μ: 30% μ΄μƒ)
- μµμ… 3: ν—μ© (κ²μ„ μ¬λ―Έ μ”μ†λ΅ κ°„μ£Ό)

---

### 2. 1μΈ λ² ν… μ‹ (λ¬΄μ΅°κ±΄ μ΄λ“ or μ†ν•΄)
```
λ² ν… λ¬Έν•­: "μ©ν›μ΄ POTG?" (μ •λ‹µ: O, λ°°μ¨: 2.0)

νμ›A: O, 1000pt β†’ +2000pt (νΌμλ§ λ² ν…)

μ‹μ¤ν… ν¬μΈνΈ λ³€λ™: +2000pt μƒμ„±
```

**κ²°κ³Ό:**
- β οΈ **1μΈ λ² ν… μ‹ μ„ν— μ—†μ΄ λ°°μ¨λ§νΌ μ΄λ“**
- λ‚΄λ¶€ μ •λ³΄ μ•…μ© κ°€λ¥μ„±

**ν•΄κ²°μ±…:**
- μµμ† λ² ν… μΈμ› μ„¤μ • (μ: 2λ… μ΄μƒ)
- λλ” 1λ…μ΄λ©΄ λ² ν… λ¬΄ν¨ν™”

---

### 3. ν¬μΈνΈ λ¶€μ΅± μ‹ λ² ν… ν—μ© μ—¬λ¶€
```
μ‹λ‚λ¦¬μ¤:
νμ›A: totalPoints = 500pt, lockedPoints = 0pt
λ² ν… μ‹λ„: 1000pt

ν—μ©?
- YES β†’ lockedPoints = 1000pt, availablePoints = 500 - 1000 = -500pt (μμ)
- NO β†’ μ—λ¬ λ°μƒ
```

**κ²°κ³Ό:**
- β“ **μ •μ±… κ²°μ • ν•„μ”**

**κ¶μ¥:**
```typescript
if (clanMember.totalPoints - clanMember.lockedPoints < betAmount) {
  throw new Error('κ°€μ© ν¬μΈνΈκ°€ λ¶€μ΅±ν•©λ‹λ‹¤');
}
```

---

### 4. ν΄λ νƒν‡΄ μ‹ λ² ν… μ²λ¦¬
```
μ‹κ°„ T1: νμ›Aκ°€ Aν΄λμ—μ„ λ² ν… (1000pt, lockedPoints += 1000)
μ‹κ°„ T2: νμ›Aκ°€ Aν΄λ νƒν‡΄ (ClanMember μ‚­μ  λλ” νƒν‡΄ μ²λ¦¬)
μ‹κ°„ T3: μ •μ‚° μ‹λ„
```

**κ²°κ³Ό:**
- β **ClanMember λ μ½”λ“κ°€ μ—†μ–΄μ„ μ •μ‚° μ‹¤ν¨**

**ν•΄κ²°μ±…:**
```typescript
// ν΄λ νƒν‡΄ μ‹ μ§„ν–‰ μ¤‘μΈ λ² ν… ν™•μΈ
const pendingBets = await findPendingBets(userId, clanId);

if (pendingBets.length > 0) {
  throw new Error('μ§„ν–‰ μ¤‘μΈ λ² ν…μ΄ μμ–΄ νƒν‡΄ν•  μ μ—†μµλ‹λ‹¤');
}

// λλ” λ² ν… μλ™ μ·¨μ†
for (const bet of pendingBets) {
  await cancelBet(bet.id); // lockedPoints ν•΄μ 
}
```

---

### 5. λ™μ‹ λ² ν… μμ • (Race Condition)
```
μ‹κ°„ T1: νμ›Aκ°€ "O, 1000pt" λ² ν… μ μ¶
μ‹κ°„ T2: νμ›Aκ°€ "X, 500pt" μμ • μ μ¶ (λ™μ‹)
μ‹κ°„ T3: λ‘ μ”μ²­μ΄ κ±°μ λ™μ‹μ— DB λ„μ°©
```

**κ²°κ³Ό:**
- β **lockedPoints λ™κΈ°ν™” λ¬Έμ  λ°μƒ κ°€λ¥**

**ν•΄κ²°μ±…:**
```typescript
await db.transaction(async (trx) => {
  const clanMember = await trx('clan_members')
    .where({ userId, clanId })
    .forUpdate() // Row Lock
    .first();

  const existing = await trx('betting_tickets')
    .where({ questionId, userId })
    .forUpdate()
    .first();

  if (existing) {
    // lockedPoints μ΅°μ •: κΈ°μ΅΄ λ² ν… κΈμ•΅ ν•΄μ  ν›„ μƒ κΈμ•΅ μ κΈ
    const diff = betAmount - existing.betAmount;
    await trx('clan_members')
      .where({ userId, clanId })
      .update({ lockedPoints: clanMember.lockedPoints + diff });

    await trx('betting_tickets')
      .where({ id: existing.id })
      .update({ prediction, betAmount });
  } else {
    // μ‹ κ· λ² ν…
    await trx('clan_members')
      .where({ userId, clanId })
      .update({ lockedPoints: clanMember.lockedPoints + betAmount });

    await trx('betting_tickets').insert({ ... });
  }
});
```

---

### 6. μ •μ‚° μ¤‘λ³µ μ‹¤ν–‰ λ°©μ§€
```
μ‹λ‚λ¦¬μ¤:
κ΄€λ¦¬μA: "μ •λ‹µ O μ…λ ¥" β†’ μ •μ‚° μ‹μ‘
κ΄€λ¦¬μB: "μ •λ‹µ O μ…λ ¥" (λ™μ‹) β†’ μ •μ‚° μ‹μ‘
```

**κ²°κ³Ό:**
- β **μ •μ‚°μ΄ 2λ² μ‹¤ν–‰λμ–΄ ν¬μΈνΈ 2λ°° μ§€κΈ‰**

**ν•΄κ²°μ±…:**
```typescript
await db.transaction(async (trx) => {
  const question = await trx('betting_questions')
    .where({ id: questionId })
    .forUpdate()
    .first();

  if (question.status === 'SETTLED') {
    throw new Error('μ΄λ―Έ μ •μ‚° μ™„λ£λ λ¬Έν•­μ…λ‹λ‹¤');
  }

  // μƒνƒλ¥Ό λ¨Όμ € λ³€κ²½ (μ¤‘λ³µ λ°©μ§€)
  await trx('betting_questions')
    .where({ id: questionId })
    .update({ status: 'SETTLED', correctAnswer });

  // μ •μ‚° μ²λ¦¬
  // ...
});
```

---

### 7. λ§κ° ν›„ μμ • μ‹λ„
```
μ‹κ°„ T1: λ§κ°μ‹κ°„ λ„λ‹¬, status = CLOSED
μ‹κ°„ T2: νμ›Aκ°€ λ§κ° μ§μ „μ— μμ • μ”μ²­ μ „μ†΅ (λ„¤νΈμ›ν¬ μ§€μ—°)
μ‹κ°„ T3: μ„λ²„κ°€ T2 μ”μ²­ μμ‹ 
```

**κ²°κ³Ό:**
- ν„μ¬ λ΅μ§: "λ§κ° μ‹κ°„ κ²½κ³Ό" μ—λ¬λ§ μ²΄ν¬
- λ¬Έμ : **Question.statusκ°€ CLOSEDμ—¬λ„ μμ • κ°€λ¥ν•  μ μμ**

**ν•΄κ²°μ±…:**
```typescript
const question = await findQuestion(questionId);

if (question.status !== 'OPEN') {
  throw new Error('λ² ν…μ΄ λ§κ°λμ—μµλ‹λ‹¤');
}

if (question.bettingDeadline && new Date() > question.bettingDeadline) {
  throw new Error('λ² ν… λ§κ° μ‹κ°„μ΄ μ§€λ‚¬μµλ‹λ‹¤');
}
```

---

### 8. λ°°μ¨ μ΅°μ‘ μ„ν—
```
μ‹λ‚λ¦¬μ¤:
μ΄μμ§„μ΄ νΉμ • λ¬Έν•­μ— λ°°μ¨ 10.0 μ„¤μ •
λ‚΄λ¶€μ μ •λ³΄λ΅ μ •λ‹µ λ―Έλ¦¬ μ•κ³  κ³ μ•΅ λ² ν…
```

**κ²°κ³Ό:**
- β οΈ **μ‹μ¤ν… ν¬μΈνΈ λ¬΄ν• μƒμ„± κ°€λ¥**

**ν•΄κ²°μ±…:**
- λ°°μ¨ μƒν•μ„  μ„¤μ • (μ: μµλ€ 5.0)
- κ³ μ•΅ λ² ν… μ•λ¦Ό μ‹μ¤ν…
- λ°°μ¨ λ³€κ²½ λ΅κ·Έ κΈ°λ΅

---

## π“‹ κ²°ν•¨ μ”μ•½ (v2)

| # | κ²°ν•¨ | μ‹¬κ°λ„ | ν•΄κ²° μƒνƒ |
|---|------|--------|----------|
| 1 | λ¨λ‘ λ§μ¶ κ²½μ° μ‹μ¤ν… ν¬μΈνΈ μ¦κ°€ | μ¤‘κ°„ | β οΈ μ •μ±… κ²°μ • ν•„μ” |
| 2 | 1μΈ λ² ν… μ‹ λ¬΄μ„ν— μ΄λ“ | μ¤‘κ°„ | β οΈ μµμ† μΈμ› μ„¤μ • κ¶μ¥ |
| 3 | ν¬μΈνΈ λ¶€μ΅± μ‹ λ² ν… ν—μ© μ—¬λ¶€ | λ‚®μ | β οΈ κ²€μ¦ λ΅μ§ ν•„μ” |
| 4 | ν΄λ νƒν‡΄ μ‹ λ² ν… μ²λ¦¬ | **λ†’μ** | **ν•„μ** |
| 5 | λ™μ‹ μμ • Race Condition | μ¤‘κ°„ | κ¶μ¥ |
| 6 | μ •μ‚° μ¤‘λ³µ μ‹¤ν–‰ κ°€λ¥ | **λ†’μ** | **ν•„μ** |
| 7 | λ§κ° ν›„ μμ • κ°€λ¥ | μ¤‘κ°„ | κ¶μ¥ |
| 8 | λ°°μ¨ μ΅°μ‘ μ„ν— | μ¤‘κ°„ | κ¶μ¥ |

---

## π― μ‹μ¤ν… κ°μ„  ν¨κ³Ό

### ν•΄κ²°λ μ£Όμ” λ¬Έμ 
β… λ¨λ‘ ν‹€λ¦° κ²½μ° ν¬μΈνΈ μ¦λ° β†’ μ‹μ¤ν… νμ
β… μ†μμ  μ²λ¦¬ λ¬Έμ  β†’ Math.ceil μ¬λ¦Ό μ²λ¦¬
β… κ°μΈ λ‚΄μ „ λ² ν… λ¬Έμ  β†’ Scrim.clanId NOT NULL
β… ν¬μΈνΈ μ°¨κ° μ‹μ  λ¶λ…ν™• β†’ totalPoints / lockedPoints λ¶„λ¦¬
β… ν¬μΈνΈ λ¶„λ°° λ³µμ΅λ„ β†’ λ‹¨μ λ°°μ¨ κ³„μ‚°

### μƒλ΅μ΄ μ¥μ 
- μ‹μ¤ν…μ΄ ν¬μΈνΈ κ³µκΈ‰λ‰ μ΅°μ  κ°€λ¥ (λ°°μ¨λ΅ μΈν”λ μ΄μ… κ΄€λ¦¬)
- μ •μ‚° λ΅μ§ λ‹¨μν™” (λ¶„λ°° κ³„μ‚° λ¶ν•„μ”)
- μ†μμ  λ¬Έμ  μ™„μ „ ν•΄κ²°
- ν¬μΈνΈ μƒνƒ λ…ν™•ν™” (total vs locked)
