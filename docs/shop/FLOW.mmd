flowchart TD
    %% 스타일 정의
    classDef member fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:black
    classDef admin fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:black
    classDef system fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:black
    classDef success fill:#c8e6c9,stroke:#388e3c,stroke-width:2px,color:black
    classDef warning fill:#ffebee,stroke:#c62828,stroke-width:2px,color:black

    Start["클랜 상점"]:::system --> Role{"역할"}:::system

    %% 회원 플로우
    Role -- "구매자" --> BrowseProducts["상품 탐색"]:::member
    BrowseProducts --> SelectProduct["상품 선택"]:::member

    SelectProduct --> CheckLimit{"구매 제한 확인<br/>(purchaseLimit)"}:::system
    CheckLimit -- "초과" --> LimitError["⚠️ 구매 한도 초과"]:::warning
    LimitError --> BrowseProducts

    CheckLimit -- "통과" --> CheckStock{"재고 있음?"}:::system
    CheckStock -- "No" --> OutOfStock["⚠️ 재고 없음"]:::warning
    OutOfStock --> BrowseProducts

    CheckStock -- "Yes" --> CheckPoints{"포인트 충분?"}:::system
    CheckPoints -- "No" --> InsufficientPoints["⚠️ 포인트 부족"]:::warning
    InsufficientPoints --> BrowseProducts

    CheckPoints -- "Yes" --> ConfirmPurchase["구매 요청"]:::member
    ConfirmPurchase --> CreatePurchase["요청 전송 (PENDING)"]:::member
    CreatePurchase --> WaitApproval["관리자 승인 대기"]:::member

    %% 승인 대기 후
    WaitApproval --> CheckStatus{"상태 확인"}:::member
    CheckStatus -- "APPROVED" --> PurchaseApproved["구매 승인!"]:::success
    CheckStatus -- "REJECTED" --> PurchaseRejected["구매 거절"]:::warning

    PurchaseApproved --> PointsDeducted["포인트 차감 완료"]:::success
    PointsDeducted --> CheckType{"상품 타입"}:::system
    
    CheckType -- "쿠폰(Voucher)" --> AutoAssign["쿠폰 자동 할당"]:::system
    AutoAssign --> ViewCoupon["[내 쿠폰함]에서<br/>핀번호 확인"]:::success
    
    CheckType -- "현물/기타" --> WaitDelivery["관리자 전달 대기"]:::member
    WaitDelivery --> ReceiveItem["물품 수령"]:::success

    %% 관리자 플로우
    Role -- "관리자" --> AdminMenu{"관리 메뉴"}:::admin
    AdminMenu -- "상품 등록" --> CreateProduct["상품 등록"]:::admin
    CreateProduct --> SetLimit["구매 제한 설정"]:::admin
    SetLimit --> CouponMode{"쿠폰 모드?"}:::admin
    CouponMode -- "Yes" --> UploadCoupons["쿠폰 코드 대량 등록"]:::admin
    CouponMode -- "No" --> SaveProduct["일반 상품 저장"]:::admin
    UploadCoupons --> SaveProduct

    AdminMenu -- "구매 승인" --> ApproveAction["구매 승인 처리"]:::admin
    ApproveAction --> SystemProcess["시스템 처리 (트랜잭션)"]:::system
    
    subgraph Approval [승인 프로세스]
        direction TB
        SP1["포인트 차감"]:::system
        SP1 --> SP2["재고 차감"]:::system
        SP2 --> SP3["쿠폰 할당 (자동)"]:::system
        SP3 --> SP4["승인 완료"]:::system
    end
    
    SystemProcess --> Approval