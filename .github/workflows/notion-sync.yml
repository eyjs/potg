name: Notion WBS 자동 동기화

on:
  push:
    branches: [master, develop]
  workflow_dispatch:

jobs:
  sync-notion:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install @notionhq/client@latest
          echo "Installed packages:"
          npm list @notionhq/client

      - name: Parse commit and sync to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_WBS_DB_ID: ${{ secrets.NOTION_WBS_DB_ID }}
          NOTION_DEVNOTE_DB_ID: ${{ secrets.NOTION_DEVNOTE_DB_ID }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
        run: node scripts/notion-sync.js

      - name: Check handoff.md changes
        id: handoff-check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "docs/handoff.md"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync handoff to Notion
        if: steps.handoff-check.outputs.changed == 'true'
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DEVNOTE_DB_ID: ${{ secrets.NOTION_DEVNOTE_DB_ID }}
        run: node scripts/notion-sync-handoff.js
